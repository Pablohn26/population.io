(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var originalData;d3.csv("data/data.csv",function(d,i){d.DOB=new Date(d.DOB);return d},function(err,data){originalData=data;data=transformData(data);render(data)});function transformData(data){var _data=_(data).groupBy(function(d,i){return d.DOB.getFullYear()}).map(function(d,i){return{date:+i,amount:d3.sum(d,function(d,i){return d.population}),age:Math.round(d3.mean(d,function(d,i){return d.AGE}))}}).sortBy("date").reverse().value();return _data}function render(data){d3.select("body").style({overflow:"visible"});d3.selectAll(".txt1, .txt3, .drawings").transition().duration(1e3).style({opacity:1});d3.select(".spinner").transition().duration(1e3).style({opacity:0});var blockSize=4;var width=960,height=1100;var graph1Box={x:50,y:10,w:0,h:0};var graph2Box={x:50,y:300,w:(blockSize+1)*100-(blockSize+1),h:350};var graph3Box={x:50,y:780,w:width-60,h:18};d3.selectAll("canvas, svg").attr({width:width,height:height});var sel=d3.select("canvas.animation");var x=d3.scale.linear().domain(d3.extent(data,function(d,i){return d.date})).rangeRound([graph2Box.w,0]);var y=d3.scale.linear().domain([0,d3.max(data,function(d,i){return d.amount})]).range([0,graph2Box.h]);var c=d3.scale.linear().domain([0,20,40,60,80]).range(["#cb0b14","#fd9728","#ffd33a","#6fa9e9","#0b6eb6"]).interpolate(linearInterpolation);var blocksData=[];_.each(data,function(d,i){var steps=y(d.amount)/(blockSize+1);var doy=d3.range(0,366,366/steps);var blocks=d3.range(steps);_.each(blocks,function(b,bi){blocksData.push({date:d.date,doy:doy[bi],age:d.age,yi:bi,bCol:i,amount:d.amount/blocks.length})})});var _delay;var delayScale=d3.scale.linear().domain([0,200,blocksData.length]).range([60,2,1]);_.reduce(blocksData,function(acc,d,i){d.delay=acc;_delay=delayScale(i);var nDelay=d.delay+_delay;return nDelay},0);_.reduce(blocksData,function(acc,d,i){d.acc=acc;return acc+d.amount},0);var sSide=Math.floor(Math.sqrt(blocksData.length));_.each(blocksData,function(d,i){d.row=i%sSide;d.col=(i-i%sSide)/sSide});graph1Box.x=width-10-(blockSize+1)-d3.max(blocksData,function(d,i){return d.col})*(blockSize+1);var xAmount=d3.scale.linear().domain([0,d3.max(blocksData,function(d,i){return d.acc})]).range([0,graph3Box.w]);_.each(blocksData,function(d,i){d.x=d.col*(blockSize+1)+graph1Box.x;d.y=d.row*(blockSize+1)+graph1Box.y;d.w=blockSize;d.h=blockSize});var ctx=sel.node().getContext("2d");d3.timer(ctxDraw);function ctxDraw(ms){ctx.fillStyle="red";ctx.clearRect(0,0,width,height);_.each(blocksData,function(d,i){ctx.fillStyle=c(d.age/365);if(i==4e3)ctx.fillStyle="black";ctx.fillRect(d.x,d.y,d.w,d.h)})}var cxtBack=document.querySelector("canvas.background").getContext("2d");_.each(blocksData,function(d,i){cxtBack.fillStyle="hsl(0,0%,85%)";cxtBack.fillRect(d.col*(blockSize+1)+graph1Box.x,d.row*(blockSize+1)+graph1Box.y,blockSize,blockSize)});_.each(blocksData,function(d,i){cxtBack.fillStyle="hsl(0,0%,85%)";cxtBack.fillRect(x(d.date)+graph2Box.x,graph2Box.h-d.yi*(blockSize+1)+graph2Box.y,blockSize,blockSize)});_.each(blocksData,function(d,i){cxtBack.fillStyle=c(d.age/365);cxtBack.fillRect(xAmount(d.acc)+graph3Box.x,graph3Box.y,2,graph3Box.h)});d3.select(".pointer").attr({transform:"translate(405,108)"}).select("path").attr({d:"M0,0 h195"}).style({fill:"none",stroke:"black","stroke-width":1,"shape-rendering":"crispEdges"});var ageScale=d3.scale.linear().domain([0,100]).range([0,graph2Box.w+blockSize]);var ageAxis=d3.svg.axis().scale(ageScale).orient("bottom").ticks(5);d3.select(".graph2XAxis").attr({transform:"translate("+graph2Box.x+","+(graph2Box.y+graph2Box.h+10)+")"}).call(ageAxis);var amountScale=d3.scale.linear().domain([0,d3.max(data,function(d,i){return d.amount})]).range([graph2Box.h+blockSize,0]);var formatN=d3.format(".0f");var amountAxis=d3.svg.axis().scale(amountScale).orient("left").tickValues(["50000000","100000000"]).tickFormat(function(d,i){var f=d3.formatPrefix(d);return formatN(f.scale(d))+" "+f.symbol});d3.select(".graph2YAxis").attr({transform:"translate("+(graph2Box.x+0)+","+graph2Box.y+")"}).call(amountAxis);var animateBlocks=true;d3.select("input#day").on("focus",function(d,i){if(!animateBlocks)return;animateBlocks=false;_.each(blocksData,function(d,i){transition({obj:d,attr:"x",newValue:x(d.date)+graph2Box.x,delay:d.delay,duration:400});transition({obj:d,attr:"y",newValue:graph2Box.h-d.yi*(blockSize+1)+graph2Box.y,delay:d.delay,duration:400})})});var line=d3.svg.line().interpolate("step-before");var peopleBefore=0;var peopleAfter=0;var format=d3.format(",f");d3.select(".button#go").on("click",function(d,i){var doyParse=d3.time.format("%j");var month=+document.querySelector("input#month").value;var day=+document.querySelector("input#day").value;var year=+document.querySelector("input#year").value;if(_.isNaN(month)||_.isNaN(day)||_.isNaN(year))return;if(month==0||day==0||year==0)return;line.interpolate("step-before");if(year<=1935)line.interpolate("step-after");var birth=new Date(year,month-1,day);var _d=_.find(originalData,function(d,i){return d.DOB.toString()==birth.toString()});if(!_d)return;var block=_.findLast(blocksData,function(d,i){return d.date==year&&+doyParse(birth)>=d.doy});d3.select("rect.you").style({fill:"black",opacity:0}).attr({x:x(block.date)+graph2Box.x-1,y:graph2Box.h-block.yi*(blockSize+1)+graph2Box.y-1,width:blockSize+2,height:blockSize+2}).transition().duration(1200).style({opacity:1});d3.select("path.you").attr({d:line([[x(block.date)+graph2Box.x+3,graph2Box.h-block.yi*(blockSize+1)+graph2Box.y+3],[605,415]])}).style({fill:"none",stroke:"black","stroke-width":1,opacity:0,"shape-rendering":"crispEdges"}).transition().duration(1200).style({opacity:1});d3.select("#sameDay").text(format(_d.population));d3.select("#sameHour").text(format(_d.population/24));d3.select(".graph3 path").attr({d:"M"+(xAmount(block.acc)+graph3Box.x)+","+(graph3Box.y-10)+" v"+(graph3Box.h+20)}).style({fill:"none",stroke:"black","stroke-width":2,"shape-rendering":"crispEdges"});var maxPop=d3.max(blocksData,function(d,i){return d.acc});var percent=block.acc*100/maxPop;peopleBefore=block.acc;peopleAfter=maxPop-block.acc;d3.select(".graph3 text.rank").text(format(percent)+"%").attr({x:xAmount(block.acc)+graph3Box.x,y:graph3Box.y+graph3Box.h+25,"text-anchor":function(){if(xAmount(block.acc)<graph3Box.w/4)return"start";if(xAmount(block.acc)>graph3Box.w/4*3)return"end";return"middle"},dy:".71em"}).style({"font-weight":500,"font-size":"22px"}).text("Your rank is: "+format(peopleBefore));d3.select(".graph3 text.percent").text(format(percent)+"%").attr({x:xAmount(block.acc)+graph3Box.x,y:graph3Box.y-35,"text-anchor":function(){if(xAmount(block.acc)<graph3Box.w/4)return"start";if(xAmount(block.acc)>graph3Box.w/4*3)return"end";return"middle"},dy:".71em"}).style({"font-weight":500,"font-size":"22px"});d3.selectAll(".txt2, .txtBefore, .txtAfter").transition().duration(1e3).style({opacity:1})});updateNumbers();function updateNumbers(){peopleBefore=peopleBefore+4.17;peopleAfter=peopleAfter-1.8;d3.select(".graph3 text.rank").text("Your rank is: "+format(peopleBefore));_.delay(updateNumbers,1e3)}}function transition(opts){var obj=opts.obj;var attr=opts.attr;var newValue=opts.newValue;var delay=opts.delay||0;var duration=opts.duration||600;var easeType=opts.ease||"linear";var interpolator=d3.interpolate(obj[attr],newValue);var ease=d3.ease(easeType);var tScale=d3.scale.linear().domain([0,duration]).range([0,1]).clamp(true);d3.timer(animate,delay);function animate(ms){obj[attr]=interpolator(ease(tScale(ms)));if(ms>duration)return true}}function linearInterpolation(a,b){return function(t){if(t<1)return a;return b}}},{}]},{},[1]);